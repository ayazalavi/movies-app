name: Build & Deploy to AWS App Runner

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  IMAGE_NAME: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build image
        run: |
          docker build -t $IMAGE_NAME:${{ github.sha }} .
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:latest

      - name: Push image
        run: |
          docker push $IMAGE_NAME:${{ github.sha }}
          docker push $IMAGE_NAME:latest

      - name: Update App Runner to new image
        run: |
          aws apprunner update-service \
            --service-arn "${{ secrets.APP_RUNNER_SERVICE_ARN }}" \
            --source-configuration "ImageRepository={ImageIdentifier=$IMAGE_NAME:${{ github.sha }},ImageRepositoryType=ECR},AutoDeploymentsEnabled=true,AuthenticationConfiguration={AccessRoleArn=${{ secrets.AWS_ROLE_TO_ASSUME }}}" \
            --instance-configuration Cpu=1vCPU,Memory=2GB \
            --observability-configuration ObservabilityEnabled=false

      - name: Propagate env vars (optional)
        run: |
          aws apprunner describe-service --service-arn "${{ secrets.APP_RUNNER_SERVICE_ARN }}"
          # If you need to set env vars from GitHub Secrets dynamically, you can:
          # aws apprunner update-service --service-arn ... \
          #   --source-configuration ... \
          #   --environment-variables KEY=VALUE KEY2=VALUE2
