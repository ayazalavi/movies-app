# apprunner.yaml
version: 1.0
runtime: nodejs22

build:
  commands:
    pre-build:
      # Ensure pnpm is available in the managed runtime
      - corepack enable
      - corepack prepare pnpm@9 --activate
      - pnpm install --frozen-lockfile
      - npx prisma generate
    build:
      - pnpm build

run:
  pre-run:
    # Apply DB migrations on each deploy (safe for Prisma in prod)
    - npx prisma migrate deploy
  command: pnpm start
  network:
    # Next.js must listen on the same port App Runner probes
    port: 3000
  env:
    - name: NODE_ENV
      value: production
    - name: DATABASE_URL
      value: postgresql://neondb_owner:npg_tziZ3ap6AHfm@ep-empty-mud-ad3v85mc-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require
